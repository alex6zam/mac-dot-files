############################## VARIABLES ##############################
export PATH=$HOME/Work/important_files/scripts:$HOME/go/bin:$HOME/.cargo/bin:$PATH

export GOPATH=$HOME/go
export PYTHONPATH=/usr/local/lib/python3.9/site-packages
export SOPS_GPG_KEY_ID=23D57B32102AA1C9177B637AF55C258E0D99259F

export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$HOME/.local/bin:/opt/homebrew/opt/mysql-client/bin:$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"
export JIRA_API_TOKEN=CUCU
export JIRA_AUTH_TYPE=bearer

export AWS_PROFILE=dev 
export AWS_SDK_LOAD_CONFIG=1
export AWS_CONFIGURE_SSO_DEFAULT_SSO_START_URL=https://d-9267024070.awsapps.com/start
export AWS_CONFIGURE_SSO_DEFAULT_SSO_REGION=us-west-2

# Gemini Cli project
export GOOGLE_CLOUD_PROJECT="eng-systems-ai-code-assist"
#######################################################################

################################ ALIAS ################################
alias l='lsd -la'
alias lt='lsd --tree'


alias work='cd ~/Work'
alias mygit='cd ~/Work/git-repos'
alias bitbucket='cd ~/Work/git-repos/Bitbucket'
alias kctx='kubectx'
alias jq-term=jid
alias rr=ranger
alias vim=nvim
alias vi=nvim
alias ls=lsd
alias search='fzf --preview "cat {}"'
alias watch=viddy
alias jq-fx=fx
alias curl-x=httpie
alias cat=bat
alias grep='rg'
alias tt='taskwarrior-tui'
alias ..='cd ..'
alias ...='cd ../..'
alias kubectl=kubecolor

#### Git from OhMyzsh ####
function __git_prompt_git() {
  GIT_OPTIONAL_LOCKS=0 command git "$@"
}

function git_current_branch() {
  local ref
  ref=$(__git_prompt_git symbolic-ref --quiet HEAD 2> /dev/null)
  local ret=$?
  if [[ $ret != 0 ]]; then
    [[ $ret == 128 ]] && return  # no git repo.
    ref=$(__git_prompt_git rev-parse --short HEAD 2> /dev/null) || return
  fi
  echo ${ref#refs/heads/}
}

function git_main_branch() {
  command git rev-parse --git-dir &>/dev/null || return
  
  local remote ref
  
  for ref in refs/{heads,remotes/{origin,upstream}}/{main,trunk,mainline,default,stable,master}; do
    if command git show-ref -q --verify $ref; then
      echo ${ref:t}
      return 0
    fi
  done
  
  # Fallback: try to get the default branch from remote HEAD symbolic refs
  for remote in origin upstream; do
    ref=$(command git rev-parse --abbrev-ref $remote/HEAD 2>/dev/null)
    if [[ $ref == $remote/* ]]; then
      echo ${ref#"$remote/"}; return 0
    fi
  done

  # If no main branch was found, fall back to master but return error
  echo master
  return 1
}
alias g='git'
alias ga='git add'
alias gaa='git add --all'
alias gb='git branch'
alias gba='git branch --all'
alias gbd='git branch --delete'
alias gbD='git branch --delete --force'
alias gcam='git commit --all --message'
alias gcas='git commit --all --signoff'
alias gcasm='git commit --all --signoff --message'
alias gcs='git commit --gpg-sign'
alias gcss='git commit --gpg-sign --signoff'
alias gcssm='git commit --gpg-sign --signoff --message'
alias gcmsg='git commit --message'
alias gcsm='git commit --signoff --message'
alias gc='git commit --verbose'
alias gca='git commit --verbose --all'
alias gca!='git commit --verbose --all --amend'
alias gcan!='git commit --verbose --all --no-edit --amend'
alias gcans!='git commit --verbose --all --signoff --no-edit --amend'
alias gcann!='git commit --verbose --all --date=now --no-edit --amend'
alias gc!='git commit --verbose --amend'
alias gcn='git commit --verbose --no-edit'
alias gcn!='git commit --verbose --no-edit --amend'
alias gd='git diff'
alias glgg='git log --graph'
alias glgga='git log --graph --decorate --all'
alias glgm='git log --graph --max-count=10'
alias glods='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ad) %C(bold blue)<%an>%Creset" --date=short'
alias glod='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ad) %C(bold blue)<%an>%Creset"'
alias glola='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ar) %C(bold blue)<%an>%Creset" --all'
alias glols='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ar) %C(bold blue)<%an>%Creset" --stat'
alias glol='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ar) %C(bold blue)<%an>%Creset"'
alias glo='git log --oneline --decorate'
alias glog='git log --oneline --decorate --graph'
alias gloga='git log --oneline --decorate --graph --all'
alias gl='git pull'
alias gpr='git pull --rebase'
alias gprv='git pull --rebase -v'
alias gpra='git pull --rebase --autostash'
alias gprav='git pull --rebase --autostash -v'
alias gst='git status'
alias gsh='git show'
alias gsps='git show --pretty=short --show-signature'
alias gstall='git stash --all'
alias gstaa='git stash apply'
alias gstc='git stash clear'
alias gstd='git stash drop'
alias gstl='git stash list'
alias gstp='git stash pop'
alias gst='git status'
alias gss='git status --short'
alias gsb='git status --short --branch'
alias gp='git push'
alias gpv='git push --verbose'
alias gpsup='git push --set-upstream origin $(git_current_branch)'
alias gco='git checkout'
alias gcor='git checkout --recurse-submodules'
alias gcb='git checkout -b'
alias gcB='git checkout -B'
alias gcm='git checkout $(git_main_branch)'
alias gcl='git clone --recurse-submodules'
##########################
#### kubectl from OhMyzsh ####

# This command is used a LOT both below and in daily life
alias k=kubectl

# Execute a kubectl command against all namespaces
alias kca='_kca(){ kubectl "$@" --all-namespaces;  unset -f _kca; }; _kca'

# Apply a YML file
alias kaf='kubectl apply -f'

# Drop into an interactive terminal on a container
alias keti='kubectl exec -t -i'

# Manage configuration quickly to switch contexts between local, dev ad staging.
alias kcuc='kubectl config use-context'
alias kcsc='kubectl config set-context'
alias kcdc='kubectl config delete-context'
alias kccc='kubectl config current-context'

# List all contexts
alias kcgc='kubectl config get-contexts'

#Â General aliases
alias kdel='kubectl delete'
alias kdelf='kubectl delete -f'
alias kge='kubectl get events --sort-by=".lastTimestamp"'
alias kgew='kubectl get events --sort-by=".lastTimestamp" --watch'

# Pod management.
alias kgp='kubectl get pods'
alias kgpl='kgp -l'
alias kgpn='kgp -n'
alias kgpsl='kubectl get pods --show-labels'
alias kgpa='kubectl get pods --all-namespaces'
alias kgpw='kgp --watch'
alias kgpwide='kgp -o wide'
alias kep='kubectl edit pods'
alias kdp='kubectl describe pods'
alias kdelp='kubectl delete pods'
alias kgpall='kubectl get pods --all-namespaces -o wide'

# Service management.
alias kgs='kubectl get svc'
alias kgsa='kubectl get svc --all-namespaces'
alias kgsw='kgs --watch'
alias kgswide='kgs -o wide'
alias kes='kubectl edit svc'
alias kds='kubectl describe svc'
alias kdels='kubectl delete svc'

# Ingress management
alias kgi='kubectl get ingress'
alias kgia='kubectl get ingress --all-namespaces'
alias kei='kubectl edit ingress'
alias kdi='kubectl describe ingress'
alias kdeli='kubectl delete ingress'

# Namespace management
alias kgns='kubectl get namespaces'
alias kens='kubectl edit namespace'
alias kdns='kubectl describe namespace'
alias kdelns='kubectl delete namespace'
alias kcn='kubectl config set-context --current --namespace'

# ConfigMap management
alias kgcm='kubectl get configmaps'
alias kgcma='kubectl get configmaps --all-namespaces'
alias kecm='kubectl edit configmap'
alias kdcm='kubectl describe configmap'
alias kdelcm='kubectl delete configmap'

# Secret management
alias kgsec='kubectl get secret'
alias kgseca='kubectl get secret --all-namespaces'
alias kdsec='kubectl describe secret'
alias kdelsec='kubectl delete secret'

# Deployment management.
alias kgd='kubectl get deployment'
alias kgda='kubectl get deployment --all-namespaces'
alias kgdw='kgd --watch'
alias kgdwide='kgd -o wide'
alias ked='kubectl edit deployment'
alias kdd='kubectl describe deployment'
alias kdeld='kubectl delete deployment'
alias ksd='kubectl scale deployment'
alias krsd='kubectl rollout status deployment'
alias krrd='kubectl rollout restart deployment'

# Rollout management.
alias kgrs='kubectl get replicaset'
alias kdrs='kubectl describe replicaset'
alias kers='kubectl edit replicaset'
alias krh='kubectl rollout history'
alias kru='kubectl rollout undo'

# Statefulset management.
alias kgss='kubectl get statefulset'
alias kgssa='kubectl get statefulset --all-namespaces'
alias kgssw='kgss --watch'
alias kgsswide='kgss -o wide'
alias kess='kubectl edit statefulset'
alias kdss='kubectl describe statefulset'
alias kdelss='kubectl delete statefulset'
alias ksss='kubectl scale statefulset'
alias krsss='kubectl rollout status statefulset'
alias krrss='kubectl rollout restart statefulset'

# Port forwarding
alias kpf="kubectl port-forward"

# Tools for accessing all information
alias kga='kubectl get all'
alias kgaa='kubectl get all --all-namespaces'

# Logs
alias kl='kubectl logs'
alias kl1h='kubectl logs --since 1h'
alias kl1m='kubectl logs --since 1m'
alias kl1s='kubectl logs --since 1s'
alias klf='kubectl logs -f'
alias klf1h='kubectl logs --since 1h -f'
alias klf1m='kubectl logs --since 1m -f'
alias klf1s='kubectl logs --since 1s -f'

# File copy
alias kcp='kubectl cp'

# Node Management
alias kgno='kubectl get nodes'
alias kgnosl='kubectl get nodes --show-labels'
alias keno='kubectl edit node'
alias kdno='kubectl describe node'
alias kdelno='kubectl delete node'

# PVC management.
alias kgpvc='kubectl get pvc'
alias kgpvca='kubectl get pvc --all-namespaces'
alias kgpvcw='kgpvc --watch'
alias kepvc='kubectl edit pvc'
alias kdpvc='kubectl describe pvc'
alias kdelpvc='kubectl delete pvc'

# Service account management.
alias kdsa="kubectl describe sa"
alias kdelsa="kubectl delete sa"

# DaemonSet management.
alias kgds='kubectl get daemonset'
alias kgdsa='kubectl get daemonset --all-namespaces'
alias kgdsw='kgds --watch'
alias keds='kubectl edit daemonset'
alias kdds='kubectl describe daemonset'
alias kdelds='kubectl delete daemonset'

# CronJob management.
alias kgcj='kubectl get cronjob'
alias kecj='kubectl edit cronjob'
alias kdcj='kubectl describe cronjob'
alias kdelcj='kubectl delete cronjob'

# Job management.
alias kgj='kubectl get job'
alias kej='kubectl edit job'
alias kdj='kubectl describe job'
alias kdelj='kubectl delete job'
##############################

alias jira-backlog="jira issue list -q \"(labels in (cbi-team-polaris)) AND status NOT in ('Done', 'Rejected', 'Dev Done', 'Resolved', 'Won\'t Fix','Cancelled') AND type not in ('Epic','CBI Release','Production Change')\" --order-by status"
alias jira-triage="jira issue list -q \"labels in (ready-for-triage) AND status NOT in ('Done', 'Rejected', 'Won\'t Fix')\" --order-by status"

alias jtowork='cd $(find ~/Work -type d | fzf)'
alias jtogit='cd $(find ~/Work/git-repos -type d | fzf)'
alias jtobitbucket='cd $(find ~/Work/git-repos/Bitbucket -type d | fzf)'
alias killp='kill $(ps aux | fzf -m | awk '{print $2}')'
alias jump='cd $(find ~/ -type d | fzf)'
alias checkout='git checkout $(git branch | fzf )'


#######################################################################
if type brew &>/dev/null; then
  FPATH=$(brew --prefix)/share/zsh-completions:$FPATH

  autoload -Uz compinit
  compinit
fi

export STARSHIP_CONFIG=$HOME/.config/starship.toml
eval "$(starship init zsh)"

############################## ZINIT ##############################
source "${HOME}/.zinit/bin/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

## plugins ##
zinit light zsh-users/zsh-autosuggestions
zinit light zsh-users/zsh-syntax-highlighting

####################################################################

aws-profile() {
    local profile_name="$1"
    echo "Setting AWS_PROFILE to '$profile_name'"
    export AWS_PROFILE="$profile_name"
    export AWS_REGION="us-west-2"
 
    # Check if the profile name matches the condition
    if [ "$profile_name" = "tsh-code-commit-dev" ]; then
        # Use AWS CLI credential_process to dynamically fetch credentials
        if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$AWS_SESSION_TOKEN" ]; then
            echo "Using credential_process"
            # Run the script to fetch temporary credentials
            json_data=$(source /Users/alexey/Work/important_files/scripts/tsh_dev_assume_role_code_commit.sh "$profile_name")
 
            # Extracting values from JSON data
            access_key_id=$(echo "$json_data" | jq -r '.AccessKeyId')
            secret_access_key=$(echo "$json_data" | jq -r '.SecretAccessKey')
            session_token=$(echo "$json_data" | jq -r '.SessionToken')
 
            # Exporting values to the terminal
            export AWS_ACCESS_KEY_ID="$access_key_id"
            export AWS_SECRET_ACCESS_KEY="$secret_access_key"
            export AWS_SESSION_TOKEN="$session_token"
        fi
    elif [ "$profile_name" = "tsh-code-commit-mod-stg" ]; then
         # Use AWS CLI credential_process to dynamically fetch credentials
        if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$AWS_SESSION_TOKEN" ]; then
            echo "Using credential_process"
            # Run the script to fetch temporary credentials
            json_data=$(source /Users/alexey/Work/important_files/scripts/tsh_mod_stg_assume_role_code_commit.sh "$profile_name")
 
            # Extracting values from JSON data
            access_key_id=$(echo "$json_data" | jq -r '.AccessKeyId')
            secret_access_key=$(echo "$json_data" | jq -r '.SecretAccessKey')
            session_token=$(echo "$json_data" | jq -r '.SessionToken')
 
            # Exporting values to the terminal
            export AWS_ACCESS_KEY_ID="$access_key_id"
            export AWS_SECRET_ACCESS_KEY="$secret_access_key"
            export AWS_SESSION_TOKEN="$session_token"
        fi  
    else
        export AWS_SECRET_ACCESS_KEY=$(aws configure get aws_secret_access_key --profile "$1")
        export AWS_ACCESS_KEY_ID=$(aws configure get aws_access_key_id --profile "$1")
        export AWS_SESSION_TOKEN=$(aws configure get aws_session_token --profile "$1")
        export AWS_REGION=$(aws configure get region --profile "$1")
        # export AWS_USE_FIPS_ENDPOINT=true
 
    fi
}
eval "$(atuin init zsh)"

[ ! -f "$HOME/.x-cmd.root/X" ] || . "$HOME/.x-cmd.root/X" # boot up x-cmd.

eval "$(zoxide init zsh)"
